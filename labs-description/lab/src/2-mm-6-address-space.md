## Виртуальное адресное пространство

Управление виртуальной памятью включает в себя три компонента:

- Выделение физических фреймов памяти.
- Выделение виртуальных страниц адресного пространства.
- Поддержание отображения виртуальных страниц в физические фреймы.

Представьте себе, что приложение попросило у ядра `size` байт памяти.
Подсистема памяти может управлять только страницами.
Она не может выдать часть страницы одному процессу, а часть другому, так как права доступа к памяти регулируются с гранулярностью в страницу[^1].
Поэтому прежде всего ядро должно посчитать, сколько страниц достаточно для удовлетворения такого запроса ---
\\( n = \lceil \frac{\texttt{size}}{\texttt{Page::SIZE}} \rceil \\), где
[`Page::SIZE`](../../doc/ku/memory/frage/struct.Frage.html#associatedconstant.SIZE) ---
размер страницы в байтах.
Из-за округления вверх, возможно, придётся выделить чуть больше запрошенного количества байт.

Далее, ядро должно найти \\( n \\) свободных физических фреймов.
Причём, благодаря собственно виртуальности, не требуется чтобы они были смежными.
Этот этап ядро может сделать лениво, то есть выделять физические фреймы только по мере того как приложение будет обращаться к выделенной памяти.
Для простоты мы не будем реализовывать ленивое выделение физических фреймов.

А вот в виртуальном адресном пространстве нужно найти блок из \\( n \\) подряд идущих свободных виртуальных страниц.
Потому что ядро должно вернуть запрошенную память непрерывным блоком адресов.
Чтобы приложение могло работать с вернувшимся блоком памяти как с непрерывным массивом размером `size` байт.
Приложение работает в виртуальных адресах, поэтому именно виртуальные адреса должны идти подряд.

Наконец, ядро должно модифицировать отображение виртуальных страниц в физические фреймы так,
чтобы только что выделенные виртуальные страницы ссылались на выделенные физические фреймы.
Если выделение памяти делается лениво, то отображение нужно модифицировать в два этапа:

- Пометить в отображении виртуальные страницы как выделенные, но не отображённые на физические фреймы.
- Когда приложение обратится к одной из этих страниц, проверить что виртуальная страница действительно была выделена. И если была, то выделить физический фрейм и отобразить виртуальную страницу на него.

На данном этапе лабораторки у нас уже есть временный аллокатор физических фреймов.
Займёмся реализацией остальных двух пунктов:

- Выделением виртуальных страниц адресного пространства.
- Поддержанием отображения виртуальных страниц в физические фреймы.

> [^1]: В 32--битном защищённом режиме [x86-64](https://en.wikipedia.org/wiki/X86-64) доступна сегментация адресного пространства. Она вводит дополнительный механизм контроля доступа к памяти с гранулярностью либо страница, либо байт, в зависимости от настроек сегмента. Этот механизм используется в статьях "Improved Address Space Switching on Pentium Processors by Transparently Multiplexing User Address Spaces" и [Performance of Address-Space Multiplexing on the Pentium](https://haeberlen.cis.upenn.edu/papers/smallspaces-tr.pdf).
